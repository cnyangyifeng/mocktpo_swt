#!/bin/bash

export BASE_DIR=`dirname $0`
export BIN_DIR=$BASE_DIR/../../bin
export DIST_DIR=$BASE_DIR/../dist-macosx

reset

if [ -d $DIST_DIR ]; then
  rm -rf $DIST_DIR
fi
mkdir $DIST_DIR

if [ -d $DIST_DIR/MockTPO.app ]; then
  rm -rf $DIST_DIR/MockTPO.app
fi
mkdir $DIST_DIR/MockTPO.app

mkdir $DIST_DIR/MockTPO.app/Contents
echo "MockTPO.app/Contents created."

cp $BASE_DIR/Info.plist $DIST_DIR/MockTPO.app/Contents
echo "MockTPO.app/Contents/Info.plist copyed."
cp $BASE_DIR/PkgInfo $DIST_DIR/MockTPO.app/Contents
echo "MockTPO.app/Contents/PkgInfo copyed."

mkdir $DIST_DIR/MockTPO.app/Contents/Resources
echo "MockTPO.app/Contents/Resources created."

iconutil -c icns $BASE_DIR/icon.iconset
mv $BASE_DIR/icon.icns $DIST_DIR/MockTPO.app/Contents/Resources
echo "MockTPO.app/Contents/Resources/icon.icns copyed."

mkdir $DIST_DIR/MockTPO.app/Contents/MacOS
echo "MockTPO.app/Contents/MacOS created."

cp -a $BIN_DIR/. $DIST_DIR/MockTPO.app/Contents/MacOS
echo "MockTPO.app/Contents/MacOS/* copyed."
cp $BASE_DIR/mocktpo $DIST_DIR/MockTPO.app/Contents/MacOS
echo "MockTPO.app/Contents/MacOS/mocktpo copyed."
cp -r $BASE_DIR/jre $DIST_DIR/MockTPO.app/Contents/MacOS
echo "MockTPO.app/Contents/MacOS/jre copyed."

echo "MockTPO.app created."

if [ -f $DIST_DIR/MockTPO.dmg ]; then
  rm -rf $DIST_DIR/MockTPO.dmg
fi
hdiutil create -srcfolder $DIST_DIR/MockTPO.app $DIST_DIR/MockTPO.dmg > /dev/null
hdiutil internet-enable -yes $DIST_DIR/MockTPO.dmg > /dev/null
echo "MockTPO.dmg created."

rm -rf $DIST_DIR/MockTPO.app
echo "MockTPO.app deleted."

hdiutil attach $DIST_DIR/MockTPO.dmg > /dev/null
echo "MockTPO.dmg attached."

if [ -d /Applications/MockTPO.app ]; then
  sudo rm -rf /Applications/MockTPO.app
fi
sudo cp -a /Volumes/MockTPO/MockTPO.app /Applications
echo "MockTPO.app installed."
umount `mount | grep MockTPO | cut -d " " -f1`
echo "MockTPO.dmg unmounted."
